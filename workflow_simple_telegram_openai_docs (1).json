from datetime import datetime
import json

# Nuevo workflow multicanal con nodo corregido y trigger de Gmail agregado
workflow_final = {
    "name": "Bot Multicanal Telegram + Gmail + OpenAI + Docs (Corregido)",
    "nodes": [
        # Telegram Trigger
        {
            "parameters": {
                "updates": ["message"]
            },
            "name": "Desencadenador de Telegram",
            "type": "n8n-nodes-base.telegramTrigger",
            "typeVersion": 1,
            "position": [250, 100]
        },
        # Gmail Trigger
        {
            "parameters": {},
            "name": "Desencadenador de Gmail",
            "type": "n8n-nodes-base.gmailTrigger",
            "typeVersion": 1,
            "position": [250, 300]
        },
        # Nodo de identificaciÃ³n
        {
            "parameters": {
                "functionCode": """
let canal, mensaje, userId, userName;

if ($node["Desencadenador de Telegram"].json?.message) {
  const data = $node["Desencadenador de Telegram"].json.message;
  canal = "Telegram";
  mensaje = data.text;
  userId = data.chat.id;
  userName = data.from.first_name || "Desconocido";
} else if ($node["Desencadenador de Gmail"].json) {
  const data = $node["Desencadenador de Gmail"].json;
  canal = "Gmail";
  mensaje = data.text || data.snippet || "(mensaje vacÃ­o)";
  userId = data.from.email;
  userName = data.from.name || "Desconocido";
} else {
  throw new Error("No se recibiÃ³ ningÃºn mensaje vÃ¡lido desde Telegram ni Gmail.");
}

return [{
  canal,
  mensaje,
  userId,
  userName
}];
"""
            },
            "name": "Preparar mensaje",
            "type": "n8n-nodes-base.function",
            "typeVersion": 1,
            "position": [450, 200]
        },
        # Nodo OpenAI
        {
            "parameters": {
                "prompt": """Eres un asistente de ventas amable, claro y profesional. Responde al siguiente mensaje considerando tÃ©cnicas de ventas (AIDA), y si es una oportunidad de venta, orienta a agendar una llamada, enviar un PDF, o continuar por este medio.

Mensaje del usuario:
{{ $json["mensaje"] }}

Servicios disponibles:
1. Desarrollo Web a medida.
2. AutomatizaciÃ³n con n8n.
3. ConsultorÃ­a en Productividad Digital.

Responde de forma persuasiva pero sin sonar forzado.
""",
                "temperature": 0.7,
                "maxTokens": 300
            },
            "name": "OpenAI",
            "type": "n8n-nodes-base.openai",
            "typeVersion": 1,
            "position": [700, 200],
            "credentials": {
                "openAiApi": {
                    "id": "1",
                    "name": "OpenAI Account"
                }
            }
        },
        # Adjuntar respuesta
        {
            "parameters": {
                "functionCode": """
const respuesta = $node["OpenAI"].json.choices[0].text;
return [{
  ...$json,
  respuesta
}];
"""
            },
            "name": "Agregar respuesta",
            "type": "n8n-nodes-base.function",
            "typeVersion": 1,
            "position": [900, 200]
        },
        # Enviar a Telegram
        {
            "parameters": {
                "chatId": "={{$json[\"userId\"]}}",
                "text": "={{$json[\"respuesta\"]}}"
            },
            "name": "Enviar un Telegram",
            "type": "n8n-nodes-base.telegram",
            "typeVersion": 1,
            "position": [1100, 100],
            "credentials": {
                "telegramApi": {
                    "id": "2",
                    "name": "Telegram Bot"
                }
            }
        },
        # Enviar por Gmail
        {
            "parameters": {
                "fromEmail": "tu-email@gmail.com",
                "toEmail": "={{$json[\"userId\"]}}",
                "subject": "Re: tu mensaje",
                "text": "={{$json[\"respuesta\"]}}"
            },
            "name": "Enviar por Gmail",
            "type": "n8n-nodes-base.gmail",
            "typeVersion": 1,
            "position": [1100, 200],
            "credentials": {
                "gmailOAuth2Api": {
                    "id": "4",
                    "name": "Gmail Account"
                }
            }
        },
        # Google Docs
        {
            "parameters": {
                "authentication": "oAuth2",
                "documentName": "Conversacion_{{$json[\"userId\"]}}",
                "content": """
ðŸ•’ Fecha: {{$now}}
ðŸ“¡ Canal: {{$json["canal"]}}
ðŸ‘¤ Usuario: {{$json["userName"]}}
ðŸ’¬ Mensaje: {{$json["mensaje"]}}
ðŸ¤– Respuesta: {{$json["respuesta"]}}

---
"""
            },
            "name": "Guardar en Google Docs",
            "type": "n8n-nodes-base.googleDocs",
            "typeVersion": 1,
            "position": [1100, 300],
            "credentials":
